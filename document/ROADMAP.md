# Crossword Solver - Roadmap

## סטטוס נוכחי (Phase 2 Complete)
- [x] זיהוי גריד מתמונה
- [x] סיווג משבצות (BLOCK/CLUE/SOLUTION)
- [x] OCR עם Google Cloud Vision
- [x] זיהוי חצים עם Claude Vision
- [x] תמיכה בזיהוי עד 2 חצים למשבצת
- [x] UI בסיסי עם Streamlit

---

## Phase 3: מבנה נתונים ולוגיקת חצים

### 3.1 לוגיקת חצים מורכבים (Offset)
**מטרה:** להבין לאן החץ מצביע ומהיכן מתחילה התשובה

**חצים פשוטים:**
| חץ | התשובה מתחילה | כיוון כתיבה |
|---|---|---|
| `down` ↓ | משבצת מתחת | למטה |
| `right` → | משבצת מימין | ימינה |
| `left` ← | משבצת משמאל | שמאלה |
| `up` ↑ | משבצת מעל | למעלה |

**חצים L-shaped (אופסט):**
| חץ | אופסט | כיוון כתיבה |
|---|---|---|
| `down-right` ↓→ | (+1 שורה, +1 עמודה) | ימינה |
| `down-left` ↓← | (+1 שורה, -1 עמודה) | שמאלה |
| `right-down` →↓ | (+1 שורה, +1 עמודה) | למטה |
| `left-down` ←↓ | (+1 שורה, -1 עמודה) | למטה |

**משימות:**
- [ ] ליצור `services/arrow_offset_calculator.py`
- [ ] מיפוי מלא של כל סוגי החצים לאופסט
- [ ] חישוב נקודת התחלה של כל תשובה
- [ ] טיפול במקרי קצה (חץ מצביע מחוץ לגריד)

### 3.2 מודל נתונים - Database Structure
**מטרה:** לארגן את כל המידע סביב הגדרות (לא משבצות)

```
ClueEntry (הגדרה בודדת):
├── id: str (unique)
├── source_cell: (row, col)
├── zone: "full" | "top" | "bottom" | "left" | "right"
├── text: str (הטקסט של ההגדרה)
├── arrow_direction: str
├── arrow_position: str
├── answer_start_cell: (row, col)  # מחושב מהחץ
├── writing_direction: "down" | "right" | "left" | "up"
├── answer_length: int  # כמות משבצות SOLUTION ברצף
├── answer_cells: List[(row, col)]  # רשימת המשבצות לפתרון
├── known_letters: Dict[int, str]  # אותיות ידועות מהצלבות
├── confidence_scores:
│   ├── ocr: float
│   ├── arrow: float
│   └── overall: float
└── candidates: List[str]  # תשובות אפשריות מהמודל
```

**משימות:**
- [ ] ליצור `models/clue_entry.py`
- [ ] ליצור `services/clue_database.py` - מנהל כל ההגדרות
- [ ] פונקציה לחישוב `answer_length` לכל הגדרה
- [ ] פונקציה לזיהוי הצלבות בין הגדרות

### 3.3 טיפול במשבצות עם 2 הגדרות
**בעיה:** איך לחלק את הטקסט בין 2 ההגדרות?

**אסטרטגיה מוצעת:**
1. אם Claude מצא 2 חצים → המשבצת חצויה
2. לפי מיקום החצים (position) → לקבוע איזה חץ שייך לאיזה חצי
3. לשלוח את התמונה שוב לקלוד עם בקשה ספציפית לפצל את הטקסט

**משימות:**
- [ ] לוגיקה לקביעת חלוקת הטקסט לפי מיקום חצים
- [ ] פרומפט ייעודי לקלוד לפיצול טקסט במשבצות חצויות
- [ ] fallback: חלוקה שווה של הטקסט (50%-50%)

---

## Phase 4: אלגוריתם הפתרון

### 4.1 שליפת תשובות מהמודל
**מטרה:** לקבל רשימת תשובות אפשריות לכל הגדרה

**Input למודל:**
- טקסט ההגדרה
- אורך התשובה (מספר אותיות)
- אותיות ידועות (מהצלבות)
- הקשר: תשבץ עברי

**Output:**
- רשימה של 10 תשובות אפשריות
- ציון ביטחון לכל תשובה

**משימות:**
- [ ] פרומפט לקלוד/GPT לפתרון הגדרות
- [ ] ממשק `services/clue_solver.py`
- [ ] caching של תשובות (אותה הגדרה + אורך = אותן תשובות)

### 4.2 אלגוריתם שיבוץ (Constraint Satisfaction)
**מטרה:** למצוא את השיבוץ הטוב ביותר של כל התשובות

**אסטרטגיה:**
1. **מיון הגדרות לפי קושי:**
   - הגדרות עם הכי הרבה אותיות ידועות = קלות יותר
   - הגדרות קצרות = קלות יותר

2. **שיבוץ חמדן (Greedy) עם Backtracking:**
   ```
   for each clue (sorted by difficulty):
       for each candidate answer:
           if fits_constraints(answer):
               place(answer)
               update_constraints()  # עדכון אותיות ידועות להגדרות אחרות
               break
       if no_valid_answer:
           backtrack()
   ```

3. **בדיקת תקינות:**
   - כל אות חייבת להיות עקבית בהצלבות
   - אם יש סתירה → backtrack

**משימות:**
- [ ] ליצור `services/puzzle_solver.py`
- [ ] מימוש בדיקת התאמה (constraints check)
- [ ] מימוש backtracking
- [ ] אופטימיזציה: Arc Consistency (AC-3)

### 4.3 ניקוד ודירוג פתרונות
**מטרה:** לבחור את הפתרון הטוב ביותר אם יש כמה אפשרויות

**מדדים:**
- כמה הגדרות נפתרו מתוך הכל
- ציון ביטחון ממוצע של התשובות
- "טבעיות" המילים (frequency בשפה העברית)

---

## Phase 5: UI ו-UX

### 5.1 תצוגת פתרון
- [ ] הצגת הגריד עם התשובות המושבצות
- [ ] צביעה לפי רמת ביטחון (ירוק/צהוב/אדום)
- [ ] אפשרות לראות תשובות חלופיות לכל הגדרה

### 5.2 עריכה ידנית
- [ ] תיקון טקסט OCR שגוי
- [ ] שינוי כיוון חץ
- [ ] הזנת תשובה ידנית
- [ ] סימון הגדרה כ"פתורה" ידנית

### 5.3 ייצוא
- [ ] ייצוא לתמונה עם הפתרון
- [ ] ייצוא ל-PDF
- [ ] שמירת מצב (לחזור אליו אחר כך)

---

## Phase 6: אופטימיזציות ושיפורים

### 6.1 ביצועים
- [ ] Batch API calls לקלוד (במקום קריאה לכל משבצת)
- [ ] Caching אגרסיבי
- [ ] עיבוד מקבילי

### 6.2 דיוק
- [ ] Fine-tuning של פרומפטים
- [ ] למידה מטעויות (feedback loop)
- [ ] מילון מילים עבריות לתיקוף תשובות

### 6.3 תמיכה בסוגי תשבצים נוספים
- [ ] תשבצי ענק
- [ ] תשבצים קריפטיים
- [ ] תשבצים באנגלית

---

## סדר עדיפויות לשבוע הקרוב

### יום 1-2: מבנה נתונים
1. `models/clue_entry.py` - המודל החדש
2. `services/clue_database.py` - ניהול ההגדרות
3. `services/arrow_offset_calculator.py` - חישוב אופסט

### יום 3: חישוב אורך תשובות
1. פונקציה לספירת משבצות SOLUTION ברצף מנקודת ההתחלה
2. עדכון כל ההגדרות עם אורך התשובה
3. זיהוי הצלבות

### יום 4-5: פתרון הגדרות
1. פרומפט לקלוד לפתרון הגדרות
2. קבלת 10 תשובות לכל הגדרה
3. שמירה ב-database

### יום 6-7: אלגוריתם שיבוץ
1. מימוש בסיסי של constraint satisfaction
2. backtracking פשוט
3. UI להצגת התוצאות

---

## הערות טכניות

### API Costs (לתכנון תקציב)
- Google Vision: ~$1.50 / 1000 תמונות
- Claude Vision: ~$0.003 / תמונה (Haiku)
- Claude Text: ~$0.01 / 1000 tokens

### Dependencies נדרשים
```
# כבר מותקן:
streamlit, opencv-python, numpy, Pillow
google-cloud-vision, anthropic

# אופציונלי להוספה:
sqlite3 (built-in) - לשמירת state
redis - ל-caching מתקדם
```
